#!/bin/bash
#http://stackoverflow.com/questions/5014823/how-to-profile-a-bash-shell-script-slow-startup
#PS4='+ \t\011 '
#exec 3>&2 2>trace.log
#set -x

set -euo pipefail

: ${KICH_SRC="$(git -C "`dirname "${BASH_SOURCE[0]}"`" rev-parse --show-toplevel)"}
: ${KICH_TGT="$HOME"}
: ${KICH_EXCLUDE=$'.*/(\.keep|\.DS_Store|\.git|LICENSE)$'}

to_tgt() {
  sed -e "s;^$KICH_SRC;$KICH_TGT;" -e "s/.link$//"
}

src_find() {
  find -E "$KICH_SRC" -not \( -regex "$KICH_EXCLUDE" -prune \) \( "$@" \)
}

tgt_dirs() {
  src_find -not \( -path '*.link' -prune \) -type d | to_tgt
}

tgt_links() {
  src_find \( -path '*.link' -prune \) -or -type f | to_tgt
}

abspath() {
  [ ! -e "$1" ] && error "'$1' does not exist"
  echo "$(cd "$(dirname "$1")" && pwd)/$(basename "$1")"
}

print0() {
  tr $'\r\n' "\0\0"
}

find_filter() {
  files="`cat`"
  [ -z "$files" ] && return

  if [ "$1" = "-L" ]; then
    mod="$1"
    shift
  fi

  print0 <<< "$files" | xargs -0 -J {} find ${mod-} {} -maxdepth 0 "$@" 2>/dev/null || true
}

src_from() {
  [[ "$1" != "$KICH_TGT"* ]] && error "'$1' not in \$KICH_TGT"
  [[ "$1" == "$KICH_SRC"* ]] && error "'$1' already synced"

  sync="${KICH_SRC}${1#"$KICH_TGT"}"
  if [ -f "$1" ]; then
    echo "$sync"
  elif [ -d "$1" ]; then
    echo "$sync.link"
  elif [ -e "$sync" ]; then
    echo "$sync"
  else
    echo "$sync.link"
  fi
}

concat() {
  for arg in "$@"; do
    [ -n "$arg" ] && echo "$arg"
  done
  true
}

rm_files() {
  files="`concat "$@" | sort -u`"
  [ -z "$files" ] && return
  echo "$files"
  read -p "About to delete [enter to continue]: "
  echo

  print0 <<< "$files" | xargs -0 rm -rf
}

git_historic_files() {
  if [ -n "${1-}" ]; then
    arg="--max-count=$1"
  fi

  git -C "$KICH_SRC" log --pretty=format: --name-only ${arg-} | sed -e '/^ *$/d' -e $'s;\.link/.*;;' -e "s;^;$KICH_SRC/;" | sort -u
}

error() {
  echo "kich: $1" >&2
  exit 1
}

install() {
  # Can't assign ${:=} in herestring <<<
  : ${tgt_dirs=`tgt_dirs`}
  : ${tgt_links=`tgt_links`}

  existdirs="`find_filter -not -type d <<< "$tgt_dirs"`"
  existlinks="`find_filter -not -type l <<< "$tgt_links"`"
  brokelinks="`git_historic_files | to_tgt | find_filter -L -type l`"

  rm_files "$existdirs" "$existlinks" "$brokelinks"

  while read -r dst; do
    # Existence check speeds things up...
    [ ! -e "$dst" ] && mkdir -p "$dst"
  done <<< "$tgt_dirs"

  while read -r dst; do
    if [ ! -e "$dst" ]; then
      echo "â‡‹ $dst"
      ln -s "`src_from "$dst"`" "$dst"
    fi
  done <<< "$tgt_links"
}

sync() {
  tgt="`abspath $1`"
  [ -L "$tgt" ] && error "'$1' is a symlink"

  src="`src_from "$tgt"`"
  mkdir -p "${src%/*}"
  mv "$tgt" "$src"
  ln -s "$src" "$tgt"
}

unsync() {
  tgt="`abspath $1`"
  [ ! -L "$tgt" ] && error "'$1' is not a symlink"
  src="`readlink "$tgt"`"
  [[ "$src" != "$KICH_SRC"* ]] && error "'$1' is not synced"
  [ ! -e "$src" ] && error "'$src' is not found"
  rm "$1"
  mv "$src" "$1"
}

uninstall() {
  rm_files "${tgt_links=`tgt_links`}"
}

src() {
  echo "$KICH_SRC"
}

case "${1-}" in
  install|sync|unsync|uninstall|src)
    command="$1"
    shift
    "$command" "$@"
    ;;
  "")
    install
    ;;
  *)
    error "'$1' is not a command"
    ;;
esac
