#!/bin/bash
#http://stackoverflow.com/questions/5014823/how-to-profile-a-bash-shell-script-slow-startup
#PS4='+ \t\011 '
#exec 3>&2 2>trace.log
#set -x

set -euo pipefail

base="$(git -C "`dirname "${BASH_SOURCE[0]}"`" rev-parse --show-toplevel)"
LINKA="$base/home"
EXCLUDE=$'.*/(\.keep|\.DS_Store)$'

to_home() {
  sed -e "s;^$LINKA;$HOME;" -e "s/.link$//"
}

tgt_find() {
  find -E "$LINKA" -not \( -regex "$EXCLUDE" -prune \) \( "$@" \) | to_home
}

tgt_dirs() {
  tgt_find -not \( -path '*.link' -prune \) -type d
}

tgt_links() {
  tgt_find \( -path '*.link' -prune \) -or -type f
}

abspath() {
  [ ! -e "$1" ] && exit_message "'$1' does not exist"
  echo "$(cd "$(dirname "$1")" && pwd)/$(basename "$1")"
}

print0() {
  tr $'\r\n' "\0\0"
}

find_filter() {
  files="`cat`"
  [ -z "$files" ] && return

  if [ "$1" = "-L" ]; then
    mod="$1"
    shift
  fi

  print0 <<< "$files" | xargs -0 -J {} find ${mod-} {} -maxdepth 0 "$@" 2>/dev/null || true
}

sync_from() {
  [[ "$1" != "$HOME"* ]] && exit_message "'$1' not in \$HOME"
  [[ "$1" == "$LINKA"* ]] && exit_message "'$1' already synced"

  sync="${LINKA}${1#$HOME}"
  if [ -f "$1" ]; then
    echo "$sync"
  elif [ -d "$1" ]; then
    echo "$sync.link"
  elif [ -e "$sync" ]; then
    echo "$sync"
  else
    echo "$sync.link"
  fi
}

concat() {
  for arg in "$@"; do
    [ -n "$arg" ] && echo "$arg"
  done
  true
}

rm_files() {
  files="`concat "$@" | sort -u`"
  [ -z "$files" ] && return
  echo "$files"
  read -p "About to delete [enter to continue]: "
  echo

  print0 <<< "$files" | xargs -0 rm -rf
}

run_log() {
  sed -e "s;$LINKA;\$LINKA;" -e "s;$HOME;\$HOME;" <<< "$@"
  "$@"
}

git_historic_files() {
  if [ -n "${1-}" ]; then
    arg="--max-count=$1"
  fi

  git -C "$base" log --pretty=format: --name-only ${arg-} | sed -e '/^ *$/d' -e "s;^;$base/;" | sort -u
}

exit_message() {
  echo "$1" >&2
  exit 1
}

install() {
  # Can't assign ${:=} in herestring <<<
  : "${tgt_dirs=`tgt_dirs`} ${tgt_links=`tgt_links`}"

  existdirs="`find_filter -not -type d <<< "$tgt_dirs"`"
  existlinks="`find_filter -not -type l <<< "$tgt_links"`"
  brokelinks="`git_historic_files | to_home | find_filter -L -type l`"

  rm_files "$existdirs" "$existlinks" "$brokelinks"

  while read -r dst; do
    # Existence check speeds things up...
    [ ! -e "$dst" ] && mkdir -p "$dst"
  done <<< "$tgt_dirs"

  while read -r dst; do
    [ ! -e "$dst" ] && run_log ln -s "`sync_from "$dst"`" "$dst"
  done <<< "$tgt_links"
}

sync() {
  file="`abspath $1`"
  [ -L "$file" ] && exit_message "'$1' is a symlink"

  sync="`sync_from "$file"`"
  mkdir -p "${sync%/*}"
  run_log mv "$file" "$sync"
  run_log ln -s "$sync" "$file"
}

unsync() {
  file="`abspath $1`"
  [ ! -L "$file" ] && exit_message "'$1' is not a symlink"
  sync="`readlink "$file"`"
  [[ "$sync" != "$LINKA"* ]] && exit_message "'$1' is not synced"
  [ ! -e "$sync" ] && exit_message "'$sync' is not found"
  rm "$1"
  run_log mv "$sync" "$1"
}

uninstall() {
  rm_files "${tgt_links=`tgt_links`}"
}

case "${1-}" in
  install|sync|unsync|uninstall)
    command="$1"
    shift
    "$command" "$@"
    ;;
  pwd)
    echo "$base"
    ;;
  "")
    install
    ;;
  *)
    exit_message "Command '$1' not found"
    ;;
esac
